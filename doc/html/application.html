<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Generic Target</title>
<link rel="stylesheet" href="core/design.css">

</head>
<body>
<header>
<div class="header_title">Generic Target</div>
<div class="header_version">Version 20210506</div>
</header>
<button onclick="PageToTop()" id="buttonToTop"></button>
<div class="wrapper">
<div class="navigation">
<ul class="ulnav">
<li class="linone"></li>
<li class="linav"><a href="index.html">Overview</a></li>
<li class="linone"></li>
<li class="litext">GETTING STARTED</li>
<li class="linav"><a href="installtoolbox.html">Install Generic Target Toolbox</a></li>
<li class="linav"><a href="preparetarget.html">Prepare Target Computer</a></li>
<li class="linav"><a href="createanddeploy.html">Create and Deploy a Model</a></li>
<li class="linone"></li>
<li class="litext">HOW THE APPLICATION WORKS</li>
<li class="linav_active"><a href="application.html">Application Overview</a></li>
<li class="linav"><a href="udpobjectmanager.html">UDP Object Manager</a></li>
<li class="linav"><a href="multicastudpobjectmanager.html">Multicast UDP Object Manager</a></li>
<li class="linav"><a href="signalmanager.html">Signal Manager</a></li>
<li class="linone"></li>
<li class="linav"><a href="textlog.html">Text Log</a></li>
<li class="linav"><a href="simulinkinterface.html">Autogenerated Interface Class</a></li>
<li class="linav"><a href="threads.html">Thread Overview</a></li>
<li class="linav"><a href="timingscheduling.html">Timing & Scheduling</a></li>
<li class="linone"></li>
<li class="litext">HOW THE DEPLOYMENT WORKS</li>
<li class="linav"><a href="buildoverview.html">Overview</a></li>
<li class="linav"><a href="buildanddeploy.html">Deployment Process</a></li>
<li class="linav"><a href="framework.html">Target Software Directory</a></li>
</ul>

</div>
<div class="content">
<h1>Generic Target Application Overview</h1>
    In addition to the actual generic target module, the generic target application consists of three other software modules: UDPObjectManager, MulticastUDPObjectManager and SignalManager.
    The generic target module is executed during the main entry function in the <a href="threads.html">main thread</a>.
    After an <a href="#initialize">initialization phase</a> the <a href="#mainloop">main-loop</a> is executed.
    Before the application is terminated, the <a href="#terminate">termination function</a> is called.
    <br>
    <br>
    <center><object data="../img/ApplicationOverview.svg" type="image/svg+xml"></object></center>
    <br>
    <br>
    The <a href="udpobjectmanager.html"><b>UDPObjectManager</b></a> manages all UDP objects.
    A UDP object contains a UDP socket, which is used for communication via UDP.
    This socket is used to send and receive messages.
    A UDP socket has a unique port.
    <br>
    <br>
    The <a href="multicastudpobjectmanager.html"><b>MulticastUDPObjectManager</b></a> manages all multicast UDP objects for multicast communication.
    A multicast UDP object contains a UDP socket, which is used for communication via UDP.
    This socket is used to send and receive messages.
    A UDP socket has a unique port.
    <br>
    <br>
    The <a href="signalmanager.html"><b>SignalManager</b></a> manages the data recording of Simulink signals.
    Only buses whose signals and sub-signals are scalar values of data type double can be recorded.
    The recorded data is automatically written to files.

<a name="initialize"></a>
<h2>Initialization</h2>
    After the application is started, the initialization phase is passed through.
    The individual steps are explained below.
    <br>
    <br>
    <center><object data="../img/ApplicationInitialize.svg" type="image/svg+xml"></object></center><br><br>
    <br>
    <br>

    <h3>1. Log Application Information</h3>
    At this point basic information about the application is displayed.
    All output is printed to the console by default.
    By a corresponding start command the output can be redirected into a file.
    With the <code>GT.GenericTarget.ShowLog()</code> method the current log file from the target computer can be displayed.
    The log file is overwritten at each start.

    <h3>2. Parse Arguments (arg)</h3>
    At this point the arguments, which were passed to the application, are evaluated.
    If the argument <code>--stop</code> is in the list of passed arguments, the termination flag is set.

    <h3>3. Open AppSocket (UDP Socket)</h3>
    The generic target application internally uses an own UDP socket.
    This UDP socket is called AppSocket.
    The port of the AppSocket cannot be used for communication via UDP within the Simulink model.
    The port can be set using the MATLAB class <code><a href="simulinkinterface.html">GT.GenericTarget</a></code>.
    The default port is 65535.

    <h3>4. Bind Port for AppSocket</h3>
    At this point the port for the application socket is bound.
    If this operation is unsuccessful, the port is already being used by another application (e.g. an already running generic target application).

    <h3>5. If (arg == "--stop")</h3>
    If the termination flag is not set, the application is terminated.
    This ensures that a generic target application is not executed multiple times at the same time.
    If the termination flag is set, a termination message is sent to the AppSocket port.
    An already running generic target application can receive this termination message and terminate itself.

    <h3>6. Send UDP Termination Message</h3>
    At this point a UDP termination message is sent. The destination is the localhost, i.e. <code>127.0.0.1</code>.

    <h3>7. If (arg == "--stop")</h3>
    If the termination flag is set, the application is terminated.

    <h3>8. SimulinkInterface::Initialize()</h3>
    This is where the Simulink model is initialized.
    All initialization callbacks of the model are called at this point.
    If UDP Send or UDP Receive blocks from the Generic Target Simulink library are used, the UDP sockets are registered at this point.
    The actual creation of all UDP sockets is then performed by the UDPObjectManager later during the initialization phase.
    The same applies to multicast UDP objects and signals to be recorded.

    <h3>9. UDPObjectManager::Create()</h3>
    All UDP objects and the corresponding UDP sockets are created at this point.
    The application is terminated if an error occurs, for example because a port could not be bound.

    <h3>10. MulticastUDPObjectManager::Create()</h3>
    All multicast UDP objects and the corresponding UDP sockets are created at this point.
    The application is terminated if an error occurs, for example because a port could not be bound.

    <h3>11. SignalManager::Create()</h3>
    The SignalManager creates a new directory in which the recorded data is stored.
    The name of the created folder corresponds to the UTC time of the target computer.
    If the SignalManager could not create a new folder, the application is closed.
    If there is no signal log block in the model, then no log directory will be created.

<a name="mainloop"></a>
<h2>Main Loop</h2>
    After the initialization phase, the main loop is executed until a termination message is received.
    The main loop is executed in the main thread and waits only for a termination message to interrupt the loop.
    <br>
    <br>
    <center><object data="../img/ApplicationMainLoop.svg" type="image/svg+xml"></object></center><br><br>
    <br>
    <br>
    <h3>1. Start Scheduler</h3>
    At this point the actual scheduler is started.
    The scheduler runs in its own <a href="threads.html">thread</a> and ensures that all <code>step()</code> methods of the Simulink model are called with the appropriate sample rate.

    <h3>2. Receive UDP via AppSocket</h3>
    The main loop waits for UDP messages.
    If the application socket was closed, for example because the application was terminated from outside (<code>Ctrl + C</code> or <code>kill</code>), the main loop is interrupted.

    <h3>3. Sender is Localhost</h3>
    At this point it is checked if the sender of a UDP message is the localhost.
    The IP address of the localhost is <code>127.0.0.1</code>.
    If the UDP message comes from a different address, this message is ignored.
    
    <div class="note-green">
	<h3 class="note-green">Note</h3>
    The termination message can also be sent from another application on the target PC.
    It is also possible to use a UDP Send block in the Simulink model that sends a termination message to the application socket.
    In this way, the generic target application can be terminated by the model software.
	</div>

    <h3>4. Received Termination Message</h3>
    If the received message is a termination message, the main loop is interrupted.
    Otherwise, the system waits again for a UDP message.
    A termination message consists of four bytes:
    <code>0x47 0x54 0xDE 0xAD</code>
    <br>
    <i>The first two bytes correspond to the ASCII characters 'G' and 'T' (for Generic Target) and the last two bytes give hexadecimal read DEAD.</i>

<a name="terminate"></a>
<h2>Termination</h2>
    During termination all network sockets and open files are closed.
    At the same time, allocated memory is freed again.
    <br>
    <br>
    <center><object data="../img/ApplicationTerminate.svg" type="image/svg+xml"></object></center><br><br>
    <br>
    <br>
    <h3>1. Stop Scheduler</h3>
    The scheduler that was started during the main loop is stopped again.
    All currently running <code>step()</code> functions of the Simulink model are still completely executed.
    However, no new <code>step()</code> function calls are started.

    <h3>2. SimulinkInterface::Terminate()</h3>
    At this point the terminattion function of the Simulink model is called.
    <code>Stop()</code> callback functions of driver blocks are also called at this point.

    <h3>3. MulticastUDPObjectManager::Destroy()</h3>
    Created multicast UDP objects are destroyed at this point.

    <h3>4. UDPObjectManager::Destroy()</h3>
    Created UDP objects are destroyed at this point.

    <h3>5. SignalManager::Destroy()</h3>
    Generated signal objects are destroyed at this point. Values that are still unwritten are written to the log files.

    <h3>6. Close AppSocket</h3>
    The application socket is closed and the generic target application is terminated.

</div>
</div>
<script src="core/script.js"></script>
</body>
</html>
